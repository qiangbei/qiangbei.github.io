## DDoS 攻击的定义

DDoS（Distributed Denial of Service）攻击，即分布式的DoS攻击。这类攻击通常都是通
过僵尸网络发起的。因僵尸网络分布于互联网各处，因此这类攻击叫分布式DoS攻击。

### DDoS 攻击的危害与特点
DDoS攻击的主要目的是获取利益，攻击者也从个体逐步向组织发展。日益频繁的DDoS攻击导致网络上充斥着大量垃圾流量，影响正常业务传输。

DDoS攻击具有如下特点：难于防范、破坏力强、易于发动、难溯源、危害大

### DoS/DDoS 攻击类型
DoS一般指单包攻击，包括畸形报文攻击和扫描窥探类攻击；DDoS指分布式的DoS攻击，分为网络层攻击和应用层攻击。

#### 畸形报文攻击
利用操作系统或应用服务的漏洞，通过少量报文导致服务器操作系统或应用系统解
析异常，甚至崩溃，如Teardrop。

#### 扫描窥探型攻击
  扫描类攻击：主机扫描和端口扫描，通过扫描获取网络可攻击的目标。
  
  特殊控制报文攻击：如TRACERT报文、IP路由记录选项控制报文，通过该类报文测探网络拓扑结构，做好攻击前准备工作。 
  
  网络层攻击：网络层攻击的目的是耗尽网络带宽或网络转发设备（如低性能路由器、FW、IPS、负载均衡）会话资源。常见的网络层攻击包括SYN Flood、SYN-ACK Flood、ACK Flood、TCP ConnectionFlood、UDP Flood、ICMP Flood等。
  
  应用层攻击：应用层攻击，主要是消耗服务器计算资源、数据库资源、应用协议栈资源等，导致服务器资源耗尽而停止对正常业务响应。常见的应用层攻击包括HTTP Flood、DNS query flood、SIP flood等。
  
### 多层防御
 
 深入分析报文，采用多层防御体系，包括静态过滤、畸形报文过滤、扫描窥探报文过滤、源合法性认证、基于会话防范、特征识别过滤和流量整形，可以有效识别畸形报文攻击、扫描窥探型攻击、风暴型攻击和应用层攻击等多种攻击类型，实现了对多种DoS/DDoS攻击流量精确清洗。
 
 畸形报文--  过滤特征 -- 过滤虚假源认证 -- 应用层认证--  会话分析 -- 行为分析--智能限速

畸形报文过滤：过滤利用协议栈漏洞的畸形报文攻击、特殊控制报文。

特征过滤：通过抓包分析来获得流量特征，基于报文的内容特征进行静态匹配过滤，主要针对没有连接状态的攻击进行防御，包括黑白名单过滤。

虚假源认证：用于防范虚假源发起的SYN Flood、ACK Flood、SYN-ACK Flood、TCP Fragment Flood攻击。

应用层攻击：用于防范虚假源或僵尸工具的DNS Query Flood、DNS Reply Flood、HTTP Flood、HTTPS Flood、SIP Flood攻击。

会话分析：针对有连接状态的报文检查是否命中会话，可有效防御FIN/RSTFlood、TCP连接耗尽攻击、TCP异常会话攻击、DNS投毒攻击、DNS反射攻击、SSL-DoS/SSL-DDoS等。

行为分析：僵尸网络发起的攻击流量和正常用户访问业务的流量在行为上存在很大差异，用户访问业务流量具有突发性，访问资源比较分散；而僵尸网络因为由僵尸工具发起，显著特征是访问速率恒定、资源固定。行为分析可有效防御HTTP慢速攻击、TCP慢速连接攻击、TCP-Ratio等。

智能限速：经过上述层层过滤后，如果流量还超过阈值，则采用限速使到达服务器的流量处于安全带宽范围内。

多层防御技术是通过整体防御策略来实现的。而防御策略可以细化基于IP、接口、基于全局、基于网段或基于防护对象来配置。

1、基于接口对流经接口的所有流量分类统计，超过阈值时进行以下防御：
- SYN Flood源认证
- SYN-ACK Flood源认证
- ACK Flood防御
- RST Flood防御
- TCP异常报文防御
- TCP分片攻击防御
- UDP Flood关联TCP类服务防范
- UDP分片报文防御
- ICMP报文限流
- DNS Request Flood源认证防御
- DNS Reply Flood源认证防御
- HTTP Flood源认证防御
- SIP Flood源认证防御
防御过程中会生成动态黑白名单。设备对黑名单中的源IP地址发出的报文禁止通过，对白名单中的源IP地址发出的报文直接转发

2、基于全局在整个设备上生效。
- 全局静态黑白名单
- 精细化特征过滤
- 单包攻击防御

3、基于网段对指向整个防护对象的所有流量分类统计，超过阈值进行防
御。
- SYN Flood源认证
- ACK Flood防御
- TCP连接耗尽攻击防御
- TCP-Ratio异常限速
- DNS Request Flood源认证防御
- DNS Reply Flood源认证防御
- HTTP源认证、目的IP的URI检测、指纹学习、慢速连接攻击防御

### 网络层攻击防御
#### TCP 类报文攻击防御
##### TCP 交互过程
在TCP/IP协议中，TCP协议提供可靠的连接服务，采用三次握手建立一个连接。
1. 第一次握手：建立连接时，客户端发送SYN包到服务器，等待服务器确认。
2. 第二次握手：服务器收到SYN包，回应一个SYN-ACK包。
3. 第三次握手：客户端收到服务器的SYN-ACK包，向服务器发送确认包ACK，此包
发送完毕，完成三次握手。
如果服务器发出的SYN-ACK包异常，客户端会发送一个RST包给服务器，服务器重新回
到监听状态。
TCP采用四次握手来关闭一个连接。

1. 第一次握手：客户端发送FIN包到服务器，表示客户端没有数据要向服务器发送
了，等待服务器确认。
2. 第二次握手：服务器收到FIN包，发送ACK包来确认客户端的FIN包，如果服务器
数据还没传完，则不发送FIN包。
3. 第三次握手：当服务器没有数据要向客户端发送时，服务器发送FIN包到客户端，
并等待客户端最终确认。
4. 第四次握手：客户端收到FIN包，发出ACK包来确认服务器的FIN包，此包发送完
毕，完成四次握手，双方连接断开。

##### TCP 异常报文攻击与防御原理
攻击

TCP报文标志位包括URG、ACK、PSH、RST、SYN、FIN六位，攻击者通过发送非法
TCP flag组合的报文，对主机造成危害。

防御原理
检查TCP报文的各个标志位URG、ACK、PSH、RST、SYN、FIN，如果标志位异常，则认为是TCP异常报文。当TCP异常报文的速率大于告警阈值时，将所有TCP异常报文全部丢弃，并记录攻击日志。
- 6个标志位全为1。
- 6个标志位全为0。
- SYN和FIN位同时为1。
- SYN和RST位同时为1。
- FIN和RST位同时为1。
- PSH、FIN和URG位同时为1。
- 仅FIN位为1。
- 仅URG位为1。
- 仅PSH位为1。
- SYN/RST/FIN标记位为1的分片报文。
- 带有载荷的SYN、SYN-ACK报文。

##### SYN Flood 攻击与防御原理
攻击

SYN Flood攻击是通过伪造一个源地址的SYN报文，发送给受害主机，受害主机回复SYNACK报文给这些地址后，不会收到ACK报文，导致受害主机保持了大量的半连接，直到超时。这些半连接可以耗尽主机资源，使受害主机无法建立正常TCP连接，从而达到攻击的目的。

防御

1、虚假源 

（1）源认证--反弹报文(一定程度增加网络拥塞)

 1）reset机制
 
伪造报文一般为源IP地址不存在或不可达，大量的半连接消耗了服务器的资源，使服务器无法处理正常的连接请求。
基于目的地址对SYN报文速率进行统计，当SYN报文速率超过阈值时，启动源认证防御。接收到SYN报文，发送一个带错误序号的SYN-ACK探测报文到SYN报文中的源IP地址。源端会回应一个rest报文。通过校验接收到的对探测报文的响应报文的真实性来确认源IP地址的真实性，以防止虚假源攻击。加入白名单！--带老化时间

 2）syn cookie 机制
 
 借鉴了HTTP中Cookie的概念。SYN Cookie技术可理解为，防火墙对TCP新建连接的协商报文进行处理，使其携带认证信息（称之为Cookie）。SYN Cookie技术利用SYN/ACK报文携带的认证信息，对握手协商的ACK报文进行了认证，从而避免了防火墙过早分配资源。当客户端向服务器发送恶意SYN报文时，既不会造成服务器上资源和带宽的消耗，也不会造成防火墙TCB资源的消耗。cookie的核心利用的时间，五元组信息并进行了hash处理防止篡改，以及验证正常的ACK回复。
由于cookie的计算只涉及了包头的部分信心，在连接建立过程中不在服务器端保存任何信息，所以失去了协议的许多功能，比如，超时重传。此外，由于计算cookie有一定的运算量，增加了连接建立的延迟时间，因此，SYN-cookie技术不能作为高性能服务器的防御手段。

 
（2）TCP代理机制--只适合来回路径一致场景

   由于常见的高性能防火墙都是能支持百万级连接的，由防火墙hold住所有的半连接，根据超时给予释放，减少后端的压力。
   
   
（3）当流量异常大时，可以采取首报丢弃措施。因为TCP支持重传。可以在接收到首包后进行丢弃，等待重传，再进行源探测机制。


2、真实源

源IP加入白名单之后将继续对真实源IP进行统计分析，对异常的源IP进行限速，以防止真实源发起攻击。
TCP-Ratio异常限速：基于源来统计除ACK以外的其他报文总和（SYN+SYN-ACK+FIN/RST）与ACK报文的比例，当这个比例超过“TCP-Ratio比例阈值”时，判定源IP地址异常，将除ACK以外的其他报文的速率总和限制在阈值内。
始终限速：任何情况下，都将除ACK以外的其他报文的速率总和限制在阈值内。


